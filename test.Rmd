---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
rm(list = ls())

library(Lahman)
library(mosaic)
library(tidyr)
library(tidyverse)
library(dplyr)
library(mplot)
library(ggplot2)
library(cluster)
library(factoextra)
library(corrplot)
library(data.table)
library(modelr)
```

```{r}
#Load in People, Batting, and Pitching Dataframes
data("People") 
data("Batting")
data("Pitching")
```

```{r}
#Merges player name to Batting data. 
bstats <- battingStats()
	str(bstats)
	

People$name <- paste(People$nameFirst, People$nameLast, sep = " ")

batting_name <- merge(Batting,
                 People[,c("playerID", "name")],
                 by = "playerID", all.x = TRUE)

#Merges player name to Pitching data.

People$name <- paste(People$nameFirst, People$nameLast, sep = " ")

pitching_name <- merge(Pitching,
                 People[,c("playerID", "name")],
                 by = "playerID", all.x = TRUE)
```

```{r}
#Creating additional stats for bstats
bstats[is.na(bstats)] = 0
#is.nan(bstats)

bstats <- bstats %>%
  mutate(K_Percent = SO / PA) %>%
  mutate(BB_Percent = (BB + IBB) / PA) %>%
  mutate_all(~replace(., is.nan(.), 0))

```

```{r}
bstats <- bstats %>%
  mutate_at(vars(K_Percent, BB_Percent), funs(round(., 3)))
```
```{r}
salary_batting <- bstats %>%
              filter(yearID >= 1985) %>%
              left_join(select(Salaries, playerID, yearID, teamID, salary), 
                         by=c("playerID", "yearID", "teamID"))
str(salary_batting)

salary_batting[is.na(salary_batting)] <- 0
```

## Data Preparation (Lesson 1 & 2)

```{r}
#Keep players with over 150 at bats. (We can change this value if necessary).
#Creating batting average variable.

batting <- bstats %>%
  filter(AB >= 150)
  
```

```{r}
bstats %>%
  filter(playerID == "bogaexa01")
```
```{r}
batting <- Batting %>%
              filter(yearID >= 1985) %>%
              left_join(select(Salaries, playerID, yearID, teamID, salary), 
                         by=c("playerID", "yearID", "teamID"))
str(batting)
```

## Exploratory Analysis (Lesson 1 & 2)
Lessons 1 and 2 will just be parts of the overall project. Simple things like data manipulation, apply functions, boxplots, etc. This will be data preparation items and exploratory analysis.

```{r}
b <- ggplot(batting, aes(x = teamID, y = HR)) +
  geom_boxplot(col = "black", aes(fill = teamID))
b

```

```{r}
hitters1 <- batting %>%
  filter(yearID < 1895) %>%
  select(SlugPct)

hitters2 <- batting %>%
  filter(yearID > 1894, yearID < 1921) %>%
  select(SlugPct)

hitters3 <- batting %>%
  filter(yearID > 1920, yearID < 1969) %>%
  select(SlugPct)

hitters4 <- batting %>%
  filter(yearID > 1969) %>%
  select(SlugPct)
#Organizing 4 different datasets looking at slugging percentage for the following boxplots. All of these are somewhat different eras, with the most dramatic split being from before 1920 (pre-Babe Ruth) and after 1920 (during and post-Babe Ruth)
```

```{r}
boxplot(hitters1,
        main = "Slugging percentage from late 1871 - 1894",
        ylab = "Slugging percentage",
        col = "blue",
        horizontal = TRUE)
```

```{r}
boxplot(hitters2, 
        main = "Slugging percentage from 1895-1920",
        ylab = "Slugging percentage",
        col = "yellow",
        horizontal = TRUE)
```

```{r}
boxplot(hitters3, 
        main = "Slugging percentage from 1921-1968",
        ylab = "Slugging percentage",
        col = "red",
        horizontal = TRUE)
```

```{r}
boxplot(hitters4, 
        main = "Slugging percentage from 1969 - present",
        ylab = "Slugging percentage",
        col = "red",
        horizontal = TRUE)
```


```{r}
sapply(hitters1, mean, na.rm = T)
sapply(hitters2, mean, na.rm = T)
sapply(hitters3, mean, na.rm = T)
sapply(hitters4, mean, na.rm = T)
#Notice that gigantic increase between hitters2 and hitters3
```

```{r}
summary(hitters1)
```

```{r}
summary(hitters2)
```

```{r}
summary(hitters3)
```

```{r}
summary(hitters4)
```

```{r}
#Keep batting stats that we want for pairs.
batting_num <- bstats %>%
  filter(PA >= 150) %>%
  select("BA", 'OBP', 'SlugPct', "SO", "BB", "HR")
  
```

```{r}
pairs(batting_num)
```
#### Career Batting Stats
```{r}
careerBatting <- na.omit(bstats)
```

```{r}
careerBatting <- careerBatting %>%
  select(playerID, BA, PA, SlugPct, OBP, SO, HR) %>%
  group_by(playerID) %>%
  summarise_all('mean')
```

```{r}
careerBatting_num <- careerBatting %>%
  filter(PA >= 150) %>%
  select(BA, PA, SlugPct, OBP, SO, HR)

pairs(careerBatting_num)
```
```{r}
corrmatrix <- cor(batting_num)
corrplot(corrmatrix, method = 'number') #Gives us correlation from pairs graph.
```

```{r}
careerBatting_num1 <- careerBatting_num %>%
  filter(PA > 500)
```


## 0-dimensional Reduction (Lesson 4)


#### Bootstrapping

## PCA (Lesson 4)
```{r}
res <- batting_num %>% prcomp(scale = TRUE)
res
```

```{r}
loadings <- res$rotation
loadings
```

```{r}
score_mat <- res$x
score_mat
```


```{r}
get_eig(res)
```

#### Screeplot
```{r}
get_eig(res) %>%
  ggplot(aes(x = 1:6, y = cumulative.variance.percent)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 80) +
  xlab("Principal Component") +
  ylab("Proportion of Variance Explained") +
  ggtitle("Scree Plot of Principal Component for Batting Statistics")
```

2 Principal Components: PC1 and PC2

```{r}
fviz_screeplot(res, main = "Scree Plot")
```

Can Identify an elbow in 3.

#### Biplot
```{r}
res %>%
  fviz_pca_var(axes = c(1,2),
               col.var = "contrib",
               gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
               repel = TRUE
               )
```

## Second Biplot Using Salary Data (Might Be Just a Test)
```{r}
salary_batting_num <- salary_batting%>%
  filter(PA >= 150) %>%
  select(BA, OBP, SlugPct, SO, HR, salary)

pairs(salary_batting_num)
```
```{r}
res1 <- salary_batting_num %>% prcomp(scale = TRUE)
res1
```
```{r}
loadings1 <- res1$rotation
loadings1
```

```{r}
score_mat1 <- res1$x
score_mat1
```
```{r}
res1 %>%
  fviz_pca_var(axes = c(1,2),
               col.var = "contrib",
               gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
               repel = TRUE
               )
```
Conclusion: You hit dingers, you get paid.

## Cluster Analysis (Lesson 5)
```{r}
#NOT COMPLETE!!!!! This was just a test, bstats is way too big.
bstats_best <- bstats %>%
  filter(PA >= 600)

eu_dist <- get_dist(careerBatting_num1, method = 'euclidean')
```

```{r}
hc_complete <- hclust(eu_dist, method = 'complete')

plot(hc_complete)
```

#### Silhouette

```{r}
res_test <- careerBatting_num1 %>% kmeans(7)
  str(res_test)
```


```{r}
distance <- get_dist(careerBatting_num1, method = "euclidean")
sil <- silhouette(x = res_test$cluster, dist = distance)
summary(sil)
sil %>% head()
```

```{r}
fviz_silhouette(sil)
```

```{r}
fviz_nbclust(careerBatting_num1, hcut, hc_method = "complete", hc_metric = "euclidean", method = "wss")
```

```{r}
##This is to test other values of K for the silhouette method.
res_test1 <- careerBatting_num1 %>% kmeans(10)
  str(res_test1)
```


```{r}
##Tests cont.
distance <- get_dist(careerBatting_num1, method="euclidean")
sil <- silhouette(x = res_test1$cluster, dist = distance)
summary(sil)
sil %>% head()
```

```{r}
fviz_silhouette(sil) ##Tests cont.
```


#### Diana

## Linear Regression (Lesson 6)

Linear Regression comparing team payroll and win rate.
```{r}
teams = as.data.table(Teams)
teams = teams[, .(yearID,
                  lgID = as.character(lgID),
                  teamID = as.character(teamID),
                  franchID = as.character(franchID),
                  Rank, G, W, L, R, ERA, SO,
                  WinPercent = W/(W+L))]

salaries = as.data.table(Salaries)
salaries = salaries[, c("lgID", "teamID", "salary1M") :=
                      list(as.character(lgID), as.character(teamID), salary / 1e6L)]
payroll = salaries[, .(payroll = sum(salary1M)), by=.(teamID, yearID)]
teamPayroll = merge(teams, payroll, by = c("teamID", "yearID"))
```

```{r}
ggplot(data = teamPayroll, aes(x = payroll, y = WinPercent)) + geom_point()  + labs(title = "") +
  geom_smooth(method = lm, se = FALSE)

```
```{r}
mod_lm <- lm(data = teamPayroll, WinPercent~payroll)
mod_lm
```

```{r}
summary(mod_lm)
```
```{r}
payroll_pred <- teamPayroll %>%
  add_predictions(mod_lm)
payroll_pred %>% head()
```

## Simple Linear Regression

## Multiple Linear Regression

<<<<<<< HEAD
## Resampling Methods

## Feature Selection
=======
## Salary Data
```{r}
franchise <- c(`ANA` = "LAA", `ARI` = "ARI", `ATL` = "ATL", 
               `BAL` = "BAL", `BOS` = "BOS", `CAL` = "LAA",
               `CHA` = "CHA", `CHN` = "CHN", `CIN` = "CIN", 
               `CLE` = "CLE", `COL` = "COL", `DET` = "DET", 
               `FLO` = "MIA", `HOU` = "HOU", `KCA` = "KCA", 
               `LAA` = "LAA", `LAN` = "LAN", `MIA` = "MIA", 
               `MIL` = "MIL", `MIN` = "MIN", `ML4` = "MIL", 
               `MON` = "WAS", `NYA` = "NYA", `NYM` = "NYN", 
               `NYN` = "NYN", `OAK` = "OAK", `PHI` = "PHI", 
               `PIT` = "PIT", `SDN` = "SDN", `SEA` = "SEA",
               `SFG` = "SFN", `SFN` = "SFN", `SLN` = "SLN", 
               `TBA` = "TBA", `TEX` = "TEX", `TOR` = "TOR",
               `WAS` = "WAS")
```

```{r}
Salaries$franchise <- unname(franchise[Salaries$teamID])
```


```{r}
avg_team_salaries <- Salaries %>%
    group_by(yearID, franchise, lgID) %>%
    summarise(salary= mean(salary)/1e6) %>%
    filter(!(franchise == "CLE" & lgID == "NL"))
```
```{r}
ggplot(avg_team_salaries, 
       aes(x = yearID, y = salary, group = factor(franchise))) +
       geom_path() +
       labs(x = "Year", y = "Average team salary (millions USD)")
```

>>>>>>> 82ab9af358f64d6e41c89024b53f893b866eece7
